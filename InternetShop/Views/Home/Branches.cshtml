@model IEnumerable<InternetShop.Models.Branch>

@{
    ViewData["Title"] = "Branches";
}

<div class="row">
    <div class="col-sm-3">
        <ul class="list-group">
            <li type="button" class="list-group-item branch-list-title">
                Branch / City Name
            </li>
            @foreach (var item in Model)
            {
            <li type="button" class="list-group-item branch-list-item" id="@item.BranchID">
                @item.City
            </li>
            }
        </ul>
    </div>
    <div class="col-sm-9">
        <div id='printoutPanel'></div>
        <div id='myMap' style='position:relative;width:800px;height:600px;'></div>
    </div>
</div>

<script type='text/javascript'>
    // When the user select branch:
    // 1. zooms in
    // 2. show the infobox with the current branch details
    // 3. mark the currect branch list item
    function branchSelected(args, branchListItem) {
        var pushpin;
        if (branchListItem === undefined) {
            pushpin = args.target;
            branchListItem = $("#" + pushpin.metadata.branchID);
        } else {
            pushpin = map.entities.get(branchListItem.context.id - 1);
        }

        $("li.branch-list-item").css('background-color', 'white');
        $(branchListItem).css('background-color', '#f2f2f2');

        map.setView({ center: pushpin.getLocation(), zoom: 15 });
        infobox.setOptions({
            location: pushpin.getLocation(),
            title: pushpin.metadata.city,
            description: "&#8226 " + pushpin.metadata.address + "<br>&#8226 " + pushpin.metadata.phoneNumber + "<br>&#8226 " + pushpin.metadata.openingHours,
            visible: true
        });
    }

    // When the user closes the infobox the map zooms out
    // unmark the currect branch list item
    function infoboxClosed(args) {
        if (!infobox.getVisible()) {
            $("li.branch-list-item").css('background-color', 'white');
            map.setView({
                center: new Microsoft.Maps.Location(31.96482358762261, 34.99964556250001),
                zoom: 8
            });
        }
    }

    function loadMapScenario() {
        map = new Microsoft.Maps.Map(document.getElementById('myMap'), {
            // Map settings when loading. Map center set to Sgula, Israel.
            credentials: 'Aoe9qNuzrXqzV9N97QUrO_TDmXB1mKLe9cSAsj6MhBvWV5GfJwFnmzs1KxxbG-BG',
            center: new Microsoft.Maps.Location(31.96482358762261, 34.99964556250001),
            zoom: 8
        });

        // Push pin for every branch
        // Get the branches list from the srver side and convert to JSON array
        var branches = @Html.Raw(Json.Serialize(Model));
        var base64Image = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAqCAYAAACgLjskAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjEuNBNAaMQAAAUjSURBVFhHzZd7TBxFHMcHUUsizFKENvGRoFYsj4C8qYApj9AmEqJgA9gQqIZgSAjBRNCAqQUl4h8qIRINt7tFrFjQ2tI2RckFEBMkFNGaii0WLChIoWII5X38nJmdZfdggeNl/CTf3NzM7/f73t7uPBatCyA7ZHI6gCThBBKFS0TXicbI99tIxH1EZiThd0lfLDqO7uZZm6CZJMtCJil8jQhsE/6TqAB9svc+XsVGJCGAJP68sqAAD3y+H4IaDkLo+Rh4pN4X7OXdK2LIVQ+Q/EO82jqY8FGSNKMvQA2qrlXD8NQILGdibgLO/H4e4puSwU5y1pkKi8T0dV51FWSnNCVQSdpb+zjU95/lpdenY7QLfL96SjNVjN/k1ZdxEoeQwVk10PdsOPxxZ4iXsp2phWlINKfpTReRSTjCXTgfo3vIwC9q0KP1fjAyNQqzs7OwsLDAS9nOnGUODn2dqJnSp7ra6X7uRpBwljpoL7tAx63L0NHRASEhIRAWFsbLbIzRmduw57N9mimdOktI+Cd1IP3bl3mKQkREBMzMzPBvG+PDniq94d+oHO2i9+4xrVOArrEfebhCZmYmJCUlQXp6uk3KysoCi8XCcu/MT4FTzUN6UzJVlGnAOh4kc2w5FRUVUFhYCJ2dnTbJ29ubZyo8Zz6qNzyOyCQtVDue+eYID9NobW1l9zEvL29d5eTkQHx8PM9UONH9jmYoYpmuKsVqx7G2bB6mMT4+Dj4+PtDU1AShoaFQX1/P2lFRUVBTU8PacXFxIEkSFBcXs39DT2WPSWconCKGzrlqR2rLSzzMmsDAQPaZm5sL7e3trJ2SkgJ9fX2sHR0dDZOTk1BWVsZ+kJ73r1ZqhhJ+jzw0zglqx4ELsTzMmoSEBBgYGIDKykqQZZn16Q3plVNSU1Oht7eXtVVyvy/QGQqvIFSF96kdu6r3wOT8JA/VKCoqAj8/P/Dy8gJ3d3eIjIwENzc3CA4OZm1HR0f2SccWFxd5lkLAuac1QxkfVvY7Sbildp7sPcVDNerq6iA7Oxva2trWFP0X9Fwd79HMJMFCLs5FmfiiUKsOPPFlEFua9AwNDUFGRga4urqCh4cHa6tKTk4GBwcHCA8PX3H/Uppf1Bt2KmYUCSfrBqCo6y2eolFaWgppaWkQExMDjY2NvBcgMTERCgoKICAgAAYHB3kvQMPAJb0ZnRKF3I1Ad2gJT6iDdrIzfPrbaZ6qQAv39/ezqygpKeG9AEFBQWyBz8/PX/ohl8e6Adc8rDMjOwZd0awQcdVSANFdZCcvu/IBWBaVZcpsNrOHxt/fnxmrlJeXg6enJ8TGxsL09DScu3nR2owJN3MXHSbB3zpIUfiFOGgd/o4Vp2vk8qeQQq/w13+uQ0qL1T3TtGI/VGEnMIMEIq8zofBq5xtQe+MLaCE/oO2vdna0KO4ug4iLh62PF1bCN1Y/zdGjnmHSVkT22jWRcJtx4iYk4puoDt3LK6+C5BxpmLwZicIxXnUdRNxgWGBDIufaOmTPK66D7LifJM2tLLIR2XoQVqFbiWEhG0T/oQ1T44LJPRg2LLiWRGEafbR8VbEVCb9gWHRN0XPLVpBwk3FhA4nkTYsdBbcC3aBFPGVooBddoGXhIM/aIiJ+zdDEStjEo7cB9u6BfzA2IhKFIVQp7ObR24QsPEmKG89NWXiWR20zolCywoweT3YMuhCL+IrOcASJjm58dIcw4SBiNM+v7nneu8PIwtvE8DT/9h9AJ7fVG+3/FoT+BctGE2PHKmlvAAAAAElFTkSuQmCC';
        var location, pushpin;
        for (var i = 0; i < branches.length; i++) {
            location = new Microsoft.Maps.Location(branches[i].latitude, branches[i].longitude);
            pushpin = new Microsoft.Maps.Pushpin(location, { icon: base64Image });
            pushpin.metadata = branches[i];
            map.entities.push(pushpin);
            Microsoft.Maps.Events.addHandler(pushpin, 'click', (args) => { branchSelected(args); });
        }

        // Add the generic infobox, set to invisible
        infobox = new Microsoft.Maps.Infobox(location, {
            visible: false,
            showPointer: false,
            maxHeight: 1500,
            offset: new Microsoft.Maps.Point(0,50)
        });
        Microsoft.Maps.Events.addHandler(infobox, 'infoboxChanged', (args) => { infoboxClosed(args); });
        infobox.setMap(map);
    }

    // Handel list iten click
    $(".branch-list-item").click(function () {
        branchSelected(null, $(this));
    });
</script>
<script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=loadMapScenario' async defer></script>