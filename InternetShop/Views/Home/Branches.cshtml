@model IEnumerable<InternetShop.Models.Branch>

@{
    ViewData["Title"] = "Branches";
}

<div class="row">
    <div class="col-sm-3" style="margin-top:10px;">
        <ul class="list-group">
            <li type="button" class="list-group-item branch-list-title">
                Branch / City Name
            </li>
            @foreach (var item in Model)
            {
            <li type="button" class="list-group-item branch-list-item" id="@item.BranchID">
                @item.City
            </li>
            }
        </ul>
    </div>
    <div class="col-sm-9">
        <div id='printoutPanel'></div>
        <div id='myMap' style='position:relative;width:800px;height:600px;margin-top:10px;'></div>
    </div>
</div>

<script type='text/javascript'>
    // When the user select branch:
    // 1. zooms in
    // 2. show the infobox with the current branch details
    // 3. mark the currect branch list item
    function branchSelected(args, branchListItem) {
        var pushpin;
        if (branchListItem === undefined) {
            pushpin = args.target;
            branchListItem = $("#" + pushpin.metadata.branchID);
        } else {
            pushpin = map.entities.get(branchListItem.context.id - 1);
        }

        $("li.branch-list-item").css('background-color', 'white');
        $(branchListItem).css('background-color', '#f2f2f2');

        map.setView({ center: pushpin.getLocation(), zoom: 15 });
        infobox.setOptions({
            location: pushpin.getLocation(),
            title: pushpin.metadata.city,
            description: "&#8226 " + pushpin.metadata.address + "<br>&#8226 " + pushpin.metadata.phoneNumber + "<br>&#8226 " + pushpin.metadata.openingHours,
            visible: true
        });
    }

    // When the user closes the infobox the map zooms out
    // unmark the currect branch list item
    function infoboxClosed(args) {
        if (!infobox.getVisible()) {
            $("li.branch-list-item").css('background-color', 'white');
            map.setView({
                center: new Microsoft.Maps.Location(31.96482358762261, 34.99964556250001),
                zoom: 8
            });
        }
    }

    function loadMapScenario() {
        map = new Microsoft.Maps.Map(document.getElementById('myMap'), {
            // Map settings when loading. Map center set to Sgula, Israel.
            credentials: 'Aoe9qNuzrXqzV9N97QUrO_TDmXB1mKLe9cSAsj6MhBvWV5GfJwFnmzs1KxxbG-BG',
            center: new Microsoft.Maps.Location(31.96482358762261, 34.99964556250001),
            zoom: 8
        });

        // Push pin for every branch
        // Get the branches list from the srver side and convert to JSON array
        var branches = @Html.Raw(Json.Serialize(Model));
        var base64Image = 'data:image/png;base64,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';
        var location, pushpin;
        for (var i = 0; i < branches.length; i++) {
            location = new Microsoft.Maps.Location(branches[i].latitude, branches[i].longitude);
            pushpin = new Microsoft.Maps.Pushpin(location, { icon: base64Image });
            pushpin.metadata = branches[i];
            map.entities.push(pushpin);
            Microsoft.Maps.Events.addHandler(pushpin, 'click', (args) => { branchSelected(args); });
        }

        // Add the generic infobox, set to invisible
        infobox = new Microsoft.Maps.Infobox(location, {
            visible: false,
            showPointer: false,
            maxHeight: 1500,
            offset: new Microsoft.Maps.Point(0,50)
        });
        Microsoft.Maps.Events.addHandler(infobox, 'infoboxChanged', (args) => { infoboxClosed(args); });
        infobox.setMap(map);
    }

    // Handel list iten click
    $(".branch-list-item").click(function () {
        branchSelected(null, $(this));
    });
</script>
<script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=loadMapScenario' async defer></script>